---
title: å‚»å­ä¹Ÿèƒ½çœ‹æ‡‚çš„Diffusion Modelsæ•°å­¦åŸºç¡€(1)
subtitle: æ•°å­¦è‹¦æ‰‹åšä¸»çš„åŒ å¿ƒä¹‹ä½œğŸ˜¼ æˆ‘éƒ½èƒ½æ‡‚ç›¸ä¿¡ä½ ä¹Ÿè¡ŒğŸ¤²
date: 2023-11-23 22:00:00
tags: [diffusion model, generative model, deep learning]
series: 0
---

> [!abstract] æ€»ç»“
>
> æœ¬ç¯‡æ–‡ç« ä»‹ç»äº†æ‰©æ•£æ¨¡å‹çš„æ•°å­¦åŸç†ï¼ˆDDPMï¼‰

# å‰è¨€

åœ¨å­¦ä¹ Diffusion Modelçš„æ—¶å€™ï¼Œæœ€å›°éš¾çš„éƒ¨åˆ†å°±æ˜¯æ•°å­¦æ¨å¯¼ã€‚è‘—åçš„å¼€å±±ä¹‹ä½œDDPMä¸­çš„æ•°å­¦æ¨å¯¼è·³æ­¥å¾ˆå¤šï¼Œéå¸¸æ™¦æ¶©ã€‚è¿™ä¿ƒæˆäº†æœ¬æ–‡çš„è¯ç”Ÿã€‚

æœ¬ç¯‡æ–‡ç« ä¼šä»¥æœ€é€šä¿—æ˜“æ‡‚çš„æ–¹å¼è¯¦ç»†æ¨å¯¼DMçš„æ•°å­¦åŸç†ï¼Œä¹‹åçš„æ–‡ç« ä¼šè®²è¿°SGMç­‰è¡ç”Ÿæ¨¡å‹çš„åŸç†ï¼Œæ¬¢è¿æŒ‡æ­£ï¼


# DDPM: Denoising Diffusion Probalilistic Model

ç”¨$x_0$è¡¨ç¤ºçœŸå®æ•°æ®ï¼Œè¿™æ˜¯ä»ä¸€ä¸ªåˆ†å¸ƒ$q(x_0)$ä¸­é‡‡æ ·çš„ç»“æœ

$\epsilon_0\sim N(0,I)$ æ˜¯ä»é«˜æ–¯åˆ†å¸ƒé‡‡æ ·å‡ºçš„å™ªéŸ³

## å‰å‘è¿‡ç¨‹

å‘$x_0$ä¸­æ·»åŠ å™ªéŸ³ï¼Œæ­¤æ—¶å¼•å…¥ä¸€ç»„å‚æ•°$\{\beta_t\}$ $\beta_t$æ˜¯ä¸æ—¶é—´æœ‰å…³çš„ä¸€ç»„å‚æ•°åºåˆ—ï¼Œdiffusionç›¸å…³å®ç°ä¸­çš„schedulerå°±æ˜¯ç”¨äºå¾—åˆ°è¿™ç»„å‚æ•°çš„

æˆ‘ä»¬ç”¨$\beta_t$è¡¨ç¤ºäº†å™ªéŸ³çš„å æ¯”ï¼Œéšç€æ—¶é—´å¢åŠ ï¼Œå™ªéŸ³çš„æ¯”ä¾‹åº”è¯¥è¶Šæ¥è¶Šå¤§ï¼Œè¿™å’Œæ‰©æ•£ç°è±¡ä¸€è‡´ï¼Œéšç€æ—¶é—´å¢é•¿ï¼Œæ•£å¼€çš„è¶Šæ¥è¶Šå¿«

<br/>

å¢åŠ å™ªéŸ³çš„è¿‡ç¨‹æ˜¯ä¸€ä¸ªé©¬å°”å¯å¤«é“¾ï¼Œå…¶ç‰¹ç‚¹æ˜¯ä¸‹ä¸€çŠ¶æ€çš„æ¦‚ç‡åˆ†å¸ƒåªèƒ½ç”±å½“å‰çŠ¶æ€å†³å®šï¼Œåœ¨æ—¶é—´åºåˆ—ä¸­å®ƒå‰é¢çš„äº‹ä»¶å‡ä¸ä¹‹æ— å…³ã€‚[^1]

åŠ å™ªè¿‡ç¨‹ä¸­ä»»æ„ä¸€æ­¥å¯ä»¥è¡¨ç¤ºä¸ºï¼š

$$x_{t}=\sqrt{1-\beta_{t}}x_{t-1}+\sqrt{\beta_t}\epsilon_{t-1}$$

> [!question] ä½ å¯èƒ½ä¼šé—®
>
> ä¸ºä»€ä¹ˆè¿™é‡Œè¦åŠ æ ¹å·ï¼Ÿ
>
> å› ä¸ºæˆ‘ä»¬éƒ½çŸ¥é“è¿™ä¸ªå‚æ•°ä¼šä»¤æ–¹å·®å‘ç”Ÿå¹³æ–¹å€çš„å˜åŒ–ï¼Œè¿™é‡ŒåŠ æ ¹å·åˆ©äºåç»­åŒ–ç®€

å¯¹äºåŠ å™ªéŸ³çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨é‡å‚æ•°åŒ–æŠ€å·§ï¼ŒæŠŠå®ƒå˜æˆä¸€ä¸ªå¼å­ï¼š

æ–¹ä¾¿åŒ–ç®€ ä»¤$\alpha_t=1-\beta_t$

$$x_{t}=\sqrt{1-\beta_{t}}x_{t-1}+\sqrt{\beta_t}\epsilon_{t-1}$$

$$=\sqrt{\alpha_{t}}x_{t-1}+\sqrt{1-\alpha_t}\epsilon_{t-1}$$

$$=\sqrt{\alpha_t}(\sqrt{\alpha_{t-1}}x_{t-2}+\sqrt{1-\alpha_{t-1}}\epsilon_{t-2})+\sqrt{1-\alpha_t}\epsilon_{t-1}$$

$$=\sqrt{\alpha_t\alpha_{t-1}}x_{t-2}+\sqrt{1-\alpha_t\alpha_{t-1}}\epsilon_{t-2}$$

......

$=\sqrt{\alpha_t...\alpha_1}x_0+\sqrt{1-(\alpha_t...\alpha_1)}x_1$

ä»¤$\overline{\alpha_t}=\prod_1^t\alpha_i$

$x_t=\sqrt{\overline{\alpha_t}}x_0+\sqrt{1-\overline{\alpha_t}}\epsilon$

æ‰€ä»¥æœä»çš„åˆ†å¸ƒæ˜¯

$q(x_t|x_0)=\mathcal{N}(x_t;\sqrt{\overline{\alpha_t}}x_0,\sqrt{1-\overline{\alpha_t}}I)$

## åå‘è¿‡ç¨‹

åå‘è¿‡ç¨‹æ˜¯ç»™å®š$x_t$ï¼Œé¢„æµ‹$x_{t-1}$

æ ¹æ®è´å¶æ–¯å…¬å¼

$q(x_{t-1}|x_t,x_0)=\frac{q(x_{t-1}|x_0)}{q(x_t|x_0)}q(x_t|x_{t-1},x_0)$

ä¸€ä¸ªä¸€ä¸ªçœ‹ï¼š

$q(x_{t-1}|x_0)\sim \mathcal{N}(\sqrt{\overline{\alpha_{t-1}}}x_0, 1-\overline{\alpha_{t-1}})$

$q(x_{t}|x_0)\sim \mathcal{N}(\sqrt{\overline{\alpha_{t}}}x_0, 1-\overline{\alpha_{t}})$

$q(x_t|x_{t-1},x_0)\sim\mathcal{N}(\sqrt{\alpha_{t}}x_{t-1}, 1-\alpha_t)$

ä»£å…¥è®¡ç®— æŠŠé«˜æ–¯åˆ†å¸ƒå±•å¼€ å› ä¸ºæˆ‘ä»¬æƒ³è¦å¾—åˆ°å‡å€¼ æ‰€ä»¥å¯ä»¥åªå…³æ³¨æŒ‡æ•°

$q(x_{t-1}|x_t,x_0)\propto exp\{-\frac{1}{2}(\frac{(x_{t-1}-\sqrt{\overline{\alpha_{t-1}}}x_0)^2}{1-\overline{\alpha_{t-1}}}+\frac{(x_{t}-\sqrt{\alpha_{t}}x_{t-1})^2}{1-\alpha_t}-\frac{(x_{t}-\sqrt{\overline{\alpha_{t}}}x_0)^2}{1-\overline{\alpha_{t}}})\}$

ç›®çš„æ˜¯åœ¨åˆ†å­é…æ–¹é…å‡ºæ¥$(x_{t-1}-\hat{\mu})^2$ï¼Œ $x_0$å’Œ$x_t$å½“æˆå‚æ•°

é…æ–¹ç»“æœæ˜¯ï¼š

$\mu(x_t,t)=\frac{1-\overline{\alpha_{t-1}}}{1-\overline{\alpha_t}}\sqrt{\alpha_t}x_t+\frac{\sqrt{\overline{\alpha_{t-1}}}\beta_t}{1-\overline{\alpha_t}}x_0$

å› ä¸º$x_0$å¯ä»¥ç”¨$x_t$è¡¨ç¤ºï¼ˆæ ¹æ®å‰å‘åŠ å™ªå…¬å¼ï¼‰

æ‰€ä»¥è¿™ä¸ªå‡å€¼å¯ä»¥è¡¨ç¤ºä¸º

$\mu(x_t,t)=\frac{1}{\sqrt{\alpha_t}}(x_t-\frac{\beta_t}{\sqrt{1-\overline{\alpha_t}}}\epsilon(x_t,t))$

å¥½å¥½å¥½ è¿™ä¸ªå¼å­é‡Œé¢åªæœ‰ä¸€ä¸ªå€¼æ˜¯æˆ‘ä»¬ä¸çŸ¥é“çš„ğŸ¥³ é‚£å°±æ˜¯$\epsilon(x_t,t)$  è¿™ä¸ªæµ“çœ‰å¤§çœ¼çš„å®¶ä¼™æ˜¯å‰å‘è¿‡ç¨‹ä¸­åŠ å…¥çš„å™ªå£°

<br/>

æ€ä¹ˆå¾—åˆ°è¿™ä¸ªå™ªå£°ï¼Ÿ

æˆ‘ä»¬æ„é€ ä¸€ä¸ªç¥ç»ç½‘ç»œæ¥é¢„æµ‹ä»–ï¼Œå› æ­¤$\epsilon$å˜ä¸º$\epsilon_\theta$ï¼Œground truthæ˜¯å‰å‘è¿‡ç¨‹æ·»åŠ çš„å™ªå£°

è¿™ä¸ªç¥ç»ç½‘ç»œçš„æŸå¤±å‡½æ•°æ˜¯ï¼š

$$L_\theta=||\epsilon-\epsilon_\theta(x_t,t)||^2$$

è€Œ $x_t=\sqrt{\overline{\alpha_t}}x_0+\sqrt{1-\overline{\alpha_t}}\epsilon$

æ‰€ä»¥ $$L_\theta=||\epsilon-\epsilon_\theta(\sqrt{\overline{\alpha_t}}x_0+\sqrt{1-\overline{\alpha_t}}\epsilon,t)||^2$$

<br />

è€Œæˆ‘ä»¬æƒ³è¦å¾—åˆ°çš„ $\hat x_{t-1}$ æœä»ä¸€ä¸ªé«˜æ–¯åˆ†å¸ƒï¼Œå…¶å‡å€¼ä¸ºï¼š

$\mu_\theta(x_t,t)=\frac{1}{\sqrt{\alpha_t}}(x_t-\frac{\beta_t}{\sqrt{1-\overline{\alpha_t}}}\epsilon_\theta(x_t,t))$ 

## ç®—æ³•è¿‡ç¨‹ç®€è¿°

ç°åœ¨ä½ å·²ç»çŸ¥é“çš„DDPMçš„æ•°å­¦åŸç†ï¼Œæˆ‘ä»¬æ ¹æ®ä¼ªä»£ç ç®€å•è¿‡ä¸€ä¸‹è®­ç»ƒå’Œé‡‡æ ·è¿‡ç¨‹ã€‚

### è®­ç»ƒè¿‡ç¨‹

è®­ç»ƒè¿‡ç¨‹å¦‚å›¾ï¼š

![DM1_1](/images/image-20231124151419607.png)

æ¯æ¬¡ä»å‡åŒ€åˆ†å¸ƒä¸­é‡‡æ ·ä¸€ä¸ªæ—¶é—´æ­¥tï¼Œä»é«˜æ–¯åˆ†å¸ƒä¸­é‡‡æ ·ä¸€ä¸ªå™ªå£°$\epsilon$ï¼Œæœ€å°åŒ–æŸå¤±å‡½æ•°ï¼Œç›´è‡³æ¨¡å‹æ”¶æ•›ã€‚

### é‡‡æ ·è¿‡ç¨‹

![DM1_2](/images/image-20231124151512063.png)

é‡‡æ ·è¿‡ç¨‹æ—¶é—´æ­¥$t$ä»å¤§åˆ°å°ï¼Œæ¯æ¬¡åˆ©ç”¨é¢„æµ‹çš„å™ªéŸ³è¿˜åŸ$x_{t-1}$æ—¶ï¼Œéœ€è¦åŠ ä¸Šé¢å¤–çš„éšæœºé«˜æ–¯å™ªéŸ³$\sigma_tz$

> [!note] note
>
> åŠ å…¥éšæœºå™ªéŸ³æ˜¯ä¸ºäº†å¸®åŠ©æ¨¡å‹æ›´å¥½åœ°å­¦ä¹ æ•°æ®çš„å¤æ‚æ€§ï¼Œä»è€Œæé«˜ç”Ÿæˆæ ·æœ¬çš„å‡†ç¡®æ€§å’Œå¤šæ ·æ€§ã€‚

# è¡¥å……

è®ºæ–‡é“¾æ¥ï¼šhttps://arxiv.org/pdf/2006.11239.pdf

å®˜æ–¹æºç ï¼š https://github.com/hojonathanho/diffusion





[^1]:https://zh.wikipedia.org/wiki/%E9%A9%AC%E5%B0%94%E5%8F%AF%E5%A4%AB%E9%93%BE

