---
title: Jax 101-5 ğŸ¤
subtitle: Pseudo Random Numbers in Jax ğŸ”‘
date: 2024-01-29 00:33:00
tags: [dl,jax]
series: 5
cover: /images/jax.jpg
---

# Pseudo Random Numbers in Jax ğŸ”‘

> [!abstract] Abstract
>
> éå¸¸é‡è¦çš„ä¸€ç« ï¼Œä¸ä»…å› ä¸ºä¼ªéšæœºæ•°æœ¬æ¥å°±æ˜¯ML/DLçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè¿˜å› ä¸ºJAXå¯¹ä¼ªéšæœºæ•°çš„å¤„ç†ä¸åŒäºnumpyï¼Œéœ€è¦ç†è§£jaxçš„ç‹¬ç‰¹æ€æƒ³ã€‚
>
> è¿™èŠ‚å®˜æ–¹æ–‡æ¡£[^1]å†™å¾—å¾ˆå¥½ï¼Œæ¸…æ™°æ˜“æ‡‚ï¼Œå»ºè®®é˜…è¯» ğŸ˜‰ğŸ“–
>
> ï¼ˆä¹Ÿå¯ä»¥ä¸é˜…è¯»å› ä¸ºæˆ‘éƒ½æ¬è¿‡æ¥äº† ğŸ‘‰ğŸ‘ˆï¼‰

## Random numbers in Numpy

åœ¨numpyä¸­ï¼Œéšæœºæ•°ç”ŸæˆåŸºäºä¸€ä¸ªå…¨å±€çŠ¶æ€

```python
import numpy as  np
np.random.seed(0)
```

`np.random.get_state()`æ–¹æ³•å¯ä»¥çœ‹è¿™ä¸ªçŠ¶æ€çš„å…·ä½“å€¼ï¼Œ æ˜¯ä¸€ä¸ªdict

æ¯æ¬¡è°ƒç”¨éšæœºçš„å‡½æ•°ï¼ŒçŠ¶æ€ä¼šè¢«æ›´æ–°



åœ¨numpyä¸­ï¼Œå¯ä»¥åŒæ—¶æŠ½å–è‹¥å¹²ä¸ªå€¼

```python
np.random.seed(0)
print(np.random.uniform(size=3))
```

numpyæä¾›äº†*sequential equivalent guarantee*ï¼ˆé¡ºåºç­‰ä»·ï¼‰ï¼Œæ„æ€æ˜¯ç‹¬ç«‹ç”Ÿæˆè‹¥å¹²ä¸ªéšæœºæ•°å’Œä¸€æ¬¡æ€§ç”Ÿæˆç»“æœä¸€è‡´ï¼Œç”¨ä»£ç è¡¨ç¤ºï¼š

```python
np.random.seed(0)
print("individually:", np.stack([np.random.uniform() for _ in range(3)]))

np.random.seed(0)
print("all at once: ", np.random.uniform(size=3))
```

##  Random numbers in JAX

Jaxä¸­çš„éšæœºæ•°å’ŒNumpyä¸åŒï¼Œå…¶ç†æƒ³çš„éšæœºæ•°åº”å½“æ»¡è¶³æ¡ä»¶ï¼š

1. å¯é‡å¤
2. å¯å¹¶è¡Œ
3. å¯å‘é‡åŒ–

### No `global state`

è€ƒè™‘ä»¥ä¸‹ä»£ç ï¼š

```python
import numpy as np

np.random.seed(0)

def bar(): return np.random.uniform()
def baz(): return np.random.uniform()

def foo(): return bar() + 2 * baz()

print(foo())
```

åœ¨éšæœºç§å­å›ºå®šæ—¶ï¼Œè¿™ä¸ªä»£ç æ»¡è¶³æ¡ä»¶1ï¼Œåªè¦`bar()`å’Œ`baz()`çš„é¡ºåºå›ºå®šï¼Œè¿™ä¸ªç¨‹åºé‡å¤å¤šæ¬¡ä¼šå¾—åˆ°ç›¸åŒç»“æœ

> æ˜¯ç¨‹åºé‡å¤å¤šæ¬¡ï¼Œè€Œä¸æ˜¯å‡½æ•°`foo()`é‡å¤å¤šæ¬¡ï¼Œå‡½æ•°é‡å¤ç»“æœå½“ç„¶æ˜¯ä¸åŒçš„

ä½†æ˜¯åœ¨Jaxä¸­ï¼Œjitä¼šä½¿å¾—å¹¶ä¸äº’ç›¸ä¾èµ–çš„å‡½æ•°`bar()`å’Œ`baz()`å¹¶è¡Œæ‰§è¡Œï¼Œä½¿å¾—ä»–ä»¬çš„æ‰§è¡Œé¡ºåºå¹¶ä¸ä¸€å®šï¼Œå› æ­¤ï¼Œæ¡ä»¶1å’Œæ¡ä»¶2ä¼šç›¸äº’ç ´å

### Key

æ‰€ä»¥åœ¨Jaxä¸­ï¼Œä¸ç»´æŠ¤å…¨å±€çŠ¶æ€ï¼Œè€Œæ˜¯æ¯ä¸ªéšæœºå‡½æ•°ç»´æŠ¤ä¸€ä¸ªçŠ¶æ€ï¼Œç§°ä¸º`key`ğŸ”‘

```python
from jax import random

key = random.PRNGKey(42)

print(key)
```

Keyçš„å›ºå®šå½¢çŠ¶ä¸ºï¼š`(2,)`

åœ¨ JAX ä¸­ï¼Œä»»ä½•éšæœºå‡½æ•°çš„è°ƒç”¨éƒ½éœ€è¦æŒ‡å®šä¸€ä¸ªå¯†é’¥ï¼Œè€Œä¸æ˜¯åƒåœ¨ NumPy ä¸­é‚£æ ·åªè®¾ç½®ä¸€æ¬¡ã€‚éšæœºå‡½æ•°ä¼šæ¶ˆè€—å¯†é’¥ï¼Œä½†ä¸ä¼šä¿®æ”¹å®ƒã€‚å‘éšæœºå‡½æ•°è¾“å…¥ç›¸åŒçš„å¯†é’¥å°†å§‹ç»ˆç”Ÿæˆç›¸åŒçš„æ ·æœ¬ï¼š

```python
print(random.normal(key))
print(random.normal(key))
```

ç»“æœæ˜¯ç›¸åŒçš„

> [!tip] **never reuse keys** 
>
> æ‰€ä»¥åœ¨å†™ç¨‹åºæ—¶ï¼Œè¦é¿å…Keyçš„é‡ç”¨ï¼

### Split key

ä¸ºäº†æ›´æ–¹ä¾¿ç®¡ç†keyï¼Œç”Ÿæˆä¸åŒä¸”ç‹¬ç«‹çš„éšæœºæ ·æœ¬ï¼Œæˆ‘ä»¬ç”¨`split()`åˆ†è£‚keyï¼Œåˆ†å‰²åé©¬ä¸Šæ¸…é™¤åŸæ¥çš„keyï¼ˆå·²ç»ç”¨äºåˆ†è£‚äº†ï¼‰                     

ç¡®å®šä¸é‡å¤ä½¿ç”¨ï¼ˆå¹¶ä¸”èŠ‚çº¦å†…å­˜ï¼‰ï¼Œåœ¨ä½¿ç”¨å**æ¸…é™¤key**

ä¸€èˆ¬å†™ä½œï¼š

```python
key, subkey = random.split(key)
```

> [!note] Note
>
> åœ¨è¿™ä¸ªå†™æ³•é‡Œé¢ï¼ŒåŸæ¥çš„keyä¼šè¢«è‡ªåŠ¨æ¸…é™¤



`split()`å¯ä»¥åˆ›å»ºå¤šäº2ä¸ªkey

```python
key, *forty_two_subkeys = random.split(key, num=43)
```

### Sequential equivalence guarantee 

é™¤äº†å…¨å±€çŠ¶æ€ä»¥å¤–ï¼Œå¦ä¸€ä¸ªä¸¤è€…çš„ä¸åŒç‚¹æ˜¯ï¼ŒJaxä¸æä¾›é¡ºåºç­‰ä»·çš„ä¿è¯ï¼Œå› ä¸ºè¿™å›å¹²æ‰°SIMDç¡¬ä»¶ä¸Šçš„çŸ¢é‡åŒ–

æ‰€ä»¥

```python
key = random.PRNGKey(42)
subkeys = random.split(key, 3)
sequence = np.stack([random.normal(subkey) for subkey in subkeys])
print("individually:", sequence)

key = random.PRNGKey(42)
print("all at once: ", random.normal(key, shape=(3,)))
```

ç»“æœæ˜¯ä¸åŒçš„ã€‚

> è¿™é‡Œç”¨ä¸€ä¸ªkeyä¸€æ¬¡æ€§ç”Ÿæˆäº†3ä¸ªæ•°ï¼Œç”±äºæ²¡æœ‰åœ¨å…¶å®ƒåœ°æ–¹é‡ç”¨ï¼Œè¿™æ ·ä½¿ç”¨æ˜¯å¯ä»¥çš„

[^1]: https://jax.readthedocs.io/en/latest/jax-101/05-random-numbers.html

